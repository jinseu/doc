## 缓存常见问题

缓存是计算机软硬设计中，最常用的组件之一，从CPU的片上Cache到日常软件开发使用的Redis等服务，cache的形式非常多样化，但是无论怎么变化，其核心问题都是一样的，包括

### 1. 缓存的更新策略

对于缓存的更新有两种策略

1. 同步更新
2. 异步更新

同步按需更新策略，是在查询缓存时，如果发现缓存的数据过期，或者不存在，那么就去数据源查询最新的数据，然后将查询到的结果放入到缓存中。那么下次查询即可直接从缓存中获取数据。

异步更新则是在服务启动后，由后台线程定期从数据源拉取数据，然后将数据放入缓存，同时清理过期数据。这样可以提高缓存命中的概率。如果能够找到数据，那么数据一定是没有过期的，只有在找不到数据时，才需要查询数据源。在部分业务场景下，可以直接返回未找到，等待后台线程下次更新，这样可以保证缓存100%命中。

两种方式的选择，需要根据实际情况而定，一般而言的原则有

1. 如果全量数据足够小，访问数据源所需时间较长，采用异步更新的模式，可以保证命中率足够高，使请求的处理时间保持相对稳定
2. 如果全量数据非常大，无法在缓存中存放全部数据，那么采用异步更新时不现实的，就需要采用同步更新策略
3. 在采用同步更新策略时，需要注意冷启动问题，服务启动时，缓存都是空的，所有的请求都无法命中，都需要访问数据源，可能导致在服务启动瞬间后端数据源过载，为了解决该问题，
 - 可以在服务启动时，拉取部分可能命中的数据，进行预填充
 - 可以在服务启动时，对请求进行限速，逐步增大请求量
4. 如果业务的请求主要集中在一部分少量数据上，可以采用两种方式结合的方式，通过预取，异步更新的方式来维护最常访问的这小部分数据。对于剩余的数据采用同步更新的方式。

### 2. 缓存击穿后的处理

singleflight


### 3. 缓存数据的过期与清理

过期数据的主动清理
过期时间随机分布，避免大量key同时过期