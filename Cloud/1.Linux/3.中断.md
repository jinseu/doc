## 中断

中断子系统是linux系统中的重要组成部分。可以通过`/proc/interrupts`查询当前Linux系统中注册的中断信息。例如一台虚拟机的中断信息如下所示，从左到右，每一列分别是irq编号，每个cpu对该irq的处理次数，中断控制器的名字，irq的名字，以及驱动程序注册该irq时使用的名字

```
           CPU0       CPU1       CPU2       CPU3       CPU4       CPU5       CPU6       CPU7
  0:         18          0          0          0          0          0          0          0   IO-APIC-edge      timer
  1:         10          0          0          0          0          0          0          0   IO-APIC-edge      i8042
  4:        440          0          0          0          0          0          0          0   IO-APIC-edge      serial
  8:          0          0          0          0          0          0          0          0   IO-APIC-edge      rtc0
  9:          0          0          0          0          0          0          0          0   IO-APIC-fasteoi   acpi
 11:          0          0          0          0          0          0          0          0   IO-APIC-fasteoi   uhci_hcd:usb1, virtio3
 14:   11660809          0          0          0          0          0          0          0   IO-APIC-edge      ata_piix
 15:          0          0          0          0          0          0          0          0   IO-APIC-edge      ata_piix
 40:          0          0          0          0          0          0          0          0   PCI-MSI-edge      virtio1-config
 41:   25034454          0          0          0          0          0          0          0   PCI-MSI-edge      virtio1-requests
 42:          0          0          0          0          0          0          0          0   PCI-MSI-edge      virtio2-config
 43:   11033757          0          0          0          0          0          0          0   PCI-MSI-edge      virtio2-requests
 44:          2          0          0          0          0          0          0          0   PCI-MSI-edge      virtio0-config
 45:  169928633          0          0          0          0          0          0          0   PCI-MSI-edge      virtio0-input.0
 46:          1          0          0          0          0          0          0          0   PCI-MSI-edge      virtio0-output.0
 47:          2  176157613          0          0          0          0          0          0   PCI-MSI-edge      virtio0-input.1
 48:          1          0          0          0          0          0          0          0   PCI-MSI-edge      virtio0-output.1
NMI:          0          0          0          0          0          0          0          0   Non-maskable interrupts
LOC: 1958132589 1657849915 1464302461 1412969718 1410404958 1414136083 1429197016 1418969785   Local timer interrupts
SPU:          0          0          0          0          0          0          0          0   Spurious interrupts
PMI:          0          0          0          0          0          0          0          0   Performance monitoring interrupts
IWI:   17320705   14373249   12736401   12565115   12658244   12767974   12794411   12401764   IRQ work interrupts
RTR:          0          0          0          0          0          0          0          0   APIC ICR read retries
RES:  155359213  149014802  142369862  139527282  137486128  139711008  134586050  134915605   Rescheduling interrupts
CAL:   22274951   22199401   42494792   42222384   41877678   44018113   42100488   43280494   Function call interrupts
TLB:   15098718   16048806   16259641   16152688   16129800   16013566   16185393   15931556   TLB shootdowns
TRM:          0          0          0          0          0          0          0          0   Thermal event interrupts
THR:          0          0          0          0          0          0          0          0   Threshold APIC interrupts
DFR:          0          0          0          0          0          0          0          0   Deferred Error APIC interrupts
MCE:          0          0          0          0          0          0          0          0   Machine check exceptions
MCP:      39802      39802      39802      39802      39802      39802      39802      39802   Machine check polls
ERR:          0
MIS:          0
```

**注意**

在上例中，可以看到有些irq的名字以edge结尾，有些以level结尾。一般情况下，以edge结尾表示边沿触发，以level结尾表示水平触发。

linux系统中还会有一个`/proc/irq`目录，该目录下面会为每个注册的irq创建一个以irq编号为名字的子目录，每个子目录下分别有以下文件（具体可能根据linux版本不同而不同，但以下三个文件是一定有的）：

1. smp_affinity irq和cpu之间的亲和性绑定，bitmask表示，为1表示该中断可以被对应编号的CPU处理。
1. smp_affinity_list irq和cpu之间的亲和性绑定，cpu list 表示。`smp_affinity_list`和`smp_affinity` 是等价的。例如`smp_affinity_list`值为`0-2,5,7`时`smp_affinity`值为`a7`。在需要时，可以任意选择其中之一变更亲和性绑定。
1. spurious 可以获得该irq被处理和未被处理的次数
1. smp_affinity_hint 含义不明

> https://lwn.net/Articles/44139/
> https://www.ibm.com/developerworks/cn/linux/l-cn-linuxkernelint/index.html
